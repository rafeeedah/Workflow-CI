# .github/workflows/ci.yml
name: CI - Retrain Model and Build Docker

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**' # Trigger hanya kalau ada perubahan di MLProject
  workflow_dispatch:

jobs:
  train-and-dockerize:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # 1. Setup Environment
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install mlflow>=2.6 dagshub scikit-learn pandas numpy joblib matplotlib scikit-optimize

      # 2. Run MLflow Project (Training)
      - name: Run MLflow Project for Training
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/german-credit-models.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          cd MLProject
          mlflow run . --env-manager=local
      
      # 3. Get Best Model Info
      - name: Get Best Model Info
        id: best_model
        run: |
          cd MLProject
          MODEL_NAME=$(grep "^model_name=" best_model_info.txt | cut -d'=' -f2 | tr -d '\n\r')
          RUN_ID=$(grep "^run_id=" best_model_info.txt | cut -d'=' -f2)
          ACCURACY=$(grep "^accuracy=" best_model_info.txt | cut -d'=' -f2)
          F1_SCORE=$(grep "^f1_score=" best_model_info.txt | cut -d'=' -f2)
          REGISTERED_NAME=$(grep "^registered_model_name=" best_model_info.txt | cut -d'=' -f2)
          
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "accuracy=$ACCURACY" >> $GITHUB_OUTPUT
          echo "f1_score=$F1_SCORE" >> $GITHUB_OUTPUT
          echo "registered_model_name=$REGISTERED_NAME" >> $GITHUB_OUTPUT
          
          echo "Best Model: $MODEL_NAME"
          echo "Run ID: $RUN_ID"
          echo "Accuracy: $ACCURACY"
          echo "F1 Score: $F1_SCORE"

      # 4. Upload ALL artifacts from ALL models to GitHub
      - name: Upload All Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-model-artifacts
          path: |
            MLProject/artifacts/*
            MLProject/mlruns/*
            MLProject/best_model_info.txt

      # 5. Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 6. Build Docker Image and Push to Docker Hub
      - name: Build and Push Best Model Docker Image
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/german-credit-models.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          cd MLProject
          
          echo "Building Docker image for best model: ${{ steps.best_model.outputs.model_name }}"
          echo "Using run ID: ${{ steps.best_model.outputs.run_id }}"
          
          # Build using run_id (most reliable)
          mlflow models build-docker \
            -m runs:/${{ steps.best_model.outputs.run_id }}/${{ steps.best_model.outputs.model_name } \
            -n german-credit-best-model
          
          # Tag for Docker Hub
          docker tag german-credit-best-model ${{ secrets.DOCKER_USERNAME }}/german_credit_model:latest
          docker tag german-credit-best-model ${{ secrets.DOCKER_USERNAME }}/german_credit_model:${{ steps.best_model.outputs.model_name }}
          
          # Push to Docker Hub
          docker push ${{ secrets.DOCKER_USERNAME }}/german_credit_model:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/german_credit_model:${{ steps.best_model.outputs.model_name }}
          
          echo "âœ“ Docker image pushed successfully!"